.install_vault: &install_vault
  - curl -s https://releases.hashicorp.com/vault/1.7.3/vault_1.7.3_linux_amd64.zip -o /tmp/vault.zip
  - unzip /tmp/vault.zip -d /usr/bin
.install_terraform: &install_terraform
  - curl -s https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip -o /tmp/terraform.zip
  - unzip /tmp/terraform.zip -d /usr/bin/
.install_yum_packages: &install_yum_packages
  - amazon-linux-extras install epel
  - yum -y install git nmap-ncat unzip ansible jq
.install_apt_packages: &install_apt_packages
  - apt-get update
  - apt-get install -y git netcat unzip ansible

.config_aws: &config_aws
  - vault login -address=$VAULT_HOST -method=$VAULT_LOGIN_METHOD username=$VAULT_LOGIN_USERNAME password="$VAULT_LOGIN_PASSWORD"
  - vault write -address=$VAULT_HOST -format=json aws-anet-tac-se-ce/sts/OL-EXT_TAC-PWUser ttl="1h" > /tmp/${CI_JOB_ID}.vault
  - mkdir -p ~/.aws
  - echo -e "[default]\nregion = us-east-2" > ~/.aws/config
  - echo -e "[default]\naws_access_key_id=$(jq -r .data.access_key < /tmp/${CI_JOB_ID}.vault)\naws_secret_access_key=$(jq -r .data.secret_key < /tmp/${CI_JOB_ID}.vault)\naws_session_token=$(jq -r .data.security_token < /tmp/${CI_JOB_ID}.vault)" > ~/.aws/credentials
.config_git: &config_git
  - git config --global credential.helper store
  - echo "https://gitlab-ci-token:${GITLAB_INTEGRATION_TOKEN}@gitlab.aristanetworks.com" > ~/.git-credentials

.run_terraform: &run_terraform
  before_script:
    - *install_apt_packages
    - *install_terraform
    - *config_git
    - sed -i "s/\(cvp_download_token.*=\) \"PLACE_YOUR_PORTAL_TOKEN_HERE\"/\1 \"$ARISTA_API_TOKEN\"/g" $VAR_FILE
    - terraform init
  script:
    - terraform apply -state=${CI_JOB_ID}.tfstate -var-file=$VAR_FILE -auto-approve
  after_script:
    - terraform destroy -state=${CI_JOB_ID}.tfstate -var-file=$VAR_FILE -auto-approve || terraform destroy -state=${CI_JOB_ID}.tfstate -var-file=$VAR_FILE -auto-approve || terraform destroy -state=${CI_JOB_ID}.tfstate -var-file=$VAR_FILE -auto-approve

stages:
  - validate
  - build
  - test
  - document
  - deploy

check for sensitive variables:
  stage: validate
  image: alpine:latest
  script:
    - if egrep -R '^cvp_download_token(.*)' *|grep -v PLACE_YOUR_PORTAL_TOKEN_HERE; then false; else true; fi

use github module URLs:
  stage: build
  image: alpine:latest
  script:
    - sed -i 's_https://gitlab.aristanetworks.com/tac-team/_https://github.com/arista-netdevops-community/_g' main.tf
    - sed -i 's_https://gitlab.aristanetworks.com/tac-team/_https://github.com/arista-netdevops-community/_g' README.md
    - sed -i 's/"gitlab"/"github"/g' main.tf
    - sed -i "s/development_release/$CI_COMMIT_SHORT_SHA/gi" main.tf
  rules:
    - if: $CI_COMMIT_BRANCH == "github"

generate documentation:
  stage: document
  image: golang:1.16
  script:
    - GO111MODULE="on" go get github.com/terraform-docs/terraform-docs@v0.14.1
    - terraform-docs pretty .
    - terraform-docs markdown --output-file README.md .
  artifacts:
    paths:
      - README.md
    expire_in: 1 hour

launch single-node cluster:
  stage: test
  image: $TERRAFORM_TEST_IMAGE
  environment: cvp-tests
  variables:
    VAR_FILE: "examples/one-node-cvp-deployment.tfvars"
  <<: *run_terraform
  artifacts:
    paths:
      - "*.tfstate"
  rules:
    - if: $CI_COMMIT_MESSAGE !~ /^\[DOC\]/

launch multi-node cluster:
  stage: test
  image: $TERRAFORM_TEST_IMAGE
  environment: cvp-tests
  variables:
    VAR_FILE: "examples/multi-node-cvp-deployment.tfvars"
  <<: *run_terraform
  artifacts:
    paths:
      - "*.tfstate"
  rules:
    - if: $CI_COMMIT_MESSAGE !~ /^\[DOC\]/

push updated documentation:
  stage: deploy
  image:
    name: alpine/git:latest
    entrypoint:
        - /bin/sh
        - -c
  environment:
    name: gitlab
  before_script:
    - git config --global user.name "$GITLAB_USER_NAME"
    - git config --global user.email "$GITLAB_USER_EMAIL"
  script:
    - git add README.md
    - git diff-index --quiet HEAD || git commit -m "$CI_COMMIT_MESSAGE "
    - git push -o ci.skip http://root:$CI_DEPLOY_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:${CI_COMMIT_BRANCH:-$CI_COMMIT_TAG}

push to github:
  stage: deploy
  image:
    name: alpine/git:latest
    entrypoint:
      - /bin/sh
      - -c
  environment:
    name: github
  before_script:
    - mkdir -p ~/.ssh
    - echo -e "$SSH_CONFIG" > ~/.ssh/config
    - echo "$GITHUB_DEPLOY_KEY"|base64 -d > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
    - apk add --no-cache rsync
    - git config --global user.name "$GITLAB_USER_NAME"
    - git config --global user.email "$GITLAB_USER_EMAIL"
  script:
    - git clone $GITHUB_PROJECT /tmp/$CI_PROJECT_NAME
    - rsync -avz --exclude=.git --exclude=.gitlab-ci.yml . /tmp/$CI_PROJECT_NAME
    - cd /tmp/$CI_PROJECT_NAME
    - git diff
    - git add .
    - git commit -m "$CI_COMMIT_MESSAGE"
    - git push
  after_script:
    - echo "Pushed $CI_COMMIT_MESSAGE"
  rules:
    - if: $CI_COMMIT_BRANCH == "github"